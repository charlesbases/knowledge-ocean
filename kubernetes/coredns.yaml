# sudo sh -c "systemctl disable systemd-resolved && systemctl disable systemd-resolved"

---
kind: ConfigMap
apiVersion: v1
metadata:
  name: coredns
  namespace: default
data:
  corefile: |
    .:53 {
      hosts {
        192.168.1.1 coredns.com
    
        ttl 5
        fallthrough
      }
    
      # 未匹配的域名转发到上游 DNS 服务器
      forward . 192.168.1.1
    
      errors
      log stdout
      
      cache 60
      reload 3s
    }

---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: coredns
  namespace: default
  labels:
    app: coredns
spec:
  replicas: 1
  restartPolicy: Always
  selector:
    matchLabels:
      app: coredns
  template:
    metadata:
      labels:
        app: coredns
    spec:
      hostNetwork: true
      nodeSelector:
        kubernetes.io/hostname: "master"
      containers:
        - name: coredns
          image: "coredns/coredns:1.10.0"
          imagePullPolicy: IfNotPresent
          ports:
            - name: udp
              protocol: UDP
              containerPort: 53
          volumeMounts:
            - name: localtime
              mountPath: /etc/localtime
            - name: corefile
              mountPath: /etc/coredns/Corefile
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 128Mi
      volumes:
        - name: localtime
          hostPath:
            path: /etc/localtime
        - name: corefile
          configMap:
            name: coredns

---
apiVersion: v1
kind: Service
metadata:
  name: coredns
  namespace: default
  labels:
    app: coredns
spec:
  ports:
    - name: coredns
      protocol: UDP
      port: 53
      targetPort: 53
  selector:
    app: coredns
  type: ClusterIP
